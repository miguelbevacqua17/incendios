<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitoreo de Incendios en Argentina</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin:0; padding:0; height:100%; width:100%; font-family:system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif; }
    #map { position:absolute; inset:0; }
    #controls, #info { position:absolute; z-index:1; background:rgba(255,255,255,.95); padding:8px 12px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,.12); font-size:14px; }
    #controls { top:12px; left:12px; display:flex; gap:8px; align-items:center; }
    #info { bottom:12px; left:12px; }
    #controls select { padding:6px 8px; border-radius:6px; border:1px solid #ddd; }
    .brand { position:absolute; top:12px; right:12px; z-index:1; background:rgba(255,255,255,.95); padding:6px 10px; border-radius:8px; box-shadow:0 2px 12px rgba(0,0,0,.12); font-size:12px; }
  </style>
</head>
<body>
  <div id="map" aria-label="Mapa de incendios"></div>

  <div id="controls">
    <label for="timeWindow">Ventana:</label>
    <select id="timeWindow">
      <option value="24h" selected>Últimas 24h</option>
      <option value="today">Hoy</option>
      <option value="3d">3 días</option>
      <option value="7d">7 días</option>
    </select>
    <label><input type="checkbox" id="heatmapToggle" /> Heatmap</label>
  </div>

  <div class="brand">Fuente: NASA FIRMS (LANCE), NASA EOSDIS</div>

  <div id="info">
    <strong>Total:</strong> <span id="count">0</span>
    &nbsp;|&nbsp;
    <strong>Última actualización:</strong> <span id="lastUpdate">–</span>
  </div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // Autodetecta backend en Codespaces: 8080 → 8000
    const BACKEND_URL = location.origin.replace("8080", "8000");

    // Estilo base vacío; inyectaremos el raster “Google-like”
    const baseStyle = { version: 8, glyphs: "https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf", sources: {}, layers: [] };

    const map = new maplibregl.Map({
      container: 'map',
      style: baseStyle,
      center: [-64.188776, -34.756118], // AR
      zoom: 4.2
    });
    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }));

    const timeSelector = document.getElementById('timeWindow');
    const heatmapToggle = document.getElementById('heatmapToggle');
    const countSpan = document.getElementById('count');
    const lastUpdateSpan = document.getElementById('lastUpdate');

    map.on('load', () => {
      const dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
      const tiles = dpr > 1
        ? [
            "https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png",
            "https://b.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png",
            "https://c.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png",
            "https://d.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png"
          ]
        : [
            "https://a.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png",
            "https://b.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png",
            "https://c.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png",
            "https://d.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png"
          ];

      map.addSource('carto-voyager', {
        type: 'raster',
        tiles,
        tileSize: 256,
        attribution:
          '© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener">OSM</a> contributors, ' +
          '© <a href="https://carto.com/attributions" target="_blank" rel="noopener">CARTO</a>'
      });

      map.addLayer({ id: 'basemap', type: 'raster', source: 'carto-voyager', minzoom: 0, maxzoom: 20 });

      refreshData(); // primera carga de datos
    });

    async function fetchFireData(window) {
      try {
        const resp = await fetch(`${BACKEND_URL}/fires?window=${window}`, { cache: 'no-store' });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);
        return await resp.json();
      } catch (err) {
        console.error('Error al recuperar datos:', err);
        alert('No se pudieron cargar los datos de incendios');
        return null;
      }
    }

    function updateLayers(data) {
      if (!data) return;

      countSpan.textContent = data.meta?.count ?? 0;
      lastUpdateSpan.textContent = data.meta?.last_update ? new Date(data.meta.last_update).toLocaleString() : '–';

      const sourceId = 'fires';
      if (map.getSource(sourceId)) {
        map.getSource(sourceId).setData(data);
        return;
      }

      map.addSource(sourceId, { type: 'geojson', data, cluster: true, clusterRadius: 50, clusterMaxZoom: 9 });

      map.addLayer({
        id: 'clusters',
        type: 'circle',
        source: sourceId,
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': ['step', ['get', 'point_count'], '#e3f2fd', 10, '#90caf9', 50, '#42a5f5', 100, '#1e88e5', 500, '#1565c0'],
          'circle-radius': ['step', ['get', 'point_count'], 14, 10, 18, 50, 22, 100, 26, 500, 30],
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 1.2
        }
      });

      map.addLayer({
        id: 'cluster-count',
        type: 'symbol',
        source: sourceId,
        filter: ['has', 'point_count'],
        layout: { 'text-field': '{point_count_abbreviated}', 'text-size': 12 },
        paint: { 'text-color': '#0d47a1' }
      });

      map.addLayer({
        id: 'unclustered-point',
        type: 'circle',
        source: sourceId,
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': ['match', ['get', 'daynight'], 'D', '#ff6d00', 'N', '#1565c0', /*default*/ '#2e7d32'],
          'circle-radius': 5,
          'circle-stroke-color': '#ffffff',
          'circle-stroke-width': 1
        }
      });

      map.addLayer({
        id: 'heatmap',
        type: 'heatmap',
        source: sourceId,
        maxzoom: 9,
        layout: { visibility: heatmapToggle.checked ? 'visible' : 'none' },
        paint: {
          'heatmap-weight': ['interpolate', ['linear'], ['get', 'frp'], 0, 0, 100, 1],
          'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, 9, 3],
          'heatmap-color': ['interpolate', ['linear'], ['heatmap-density'], 0, 'rgba(0,0,0,0)', 0.1, '#e3f2fd', 0.3, '#90caf9', 0.5, '#42a5f5', 0.7, '#1e88e5', 1, '#0d47a1'],
          'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 0, 2, 9, 24],
          'heatmap-opacity': 0.7
        }
      });

      map.on('click', 'unclustered-point', (e) => {
        const f = e.features[0], p = f.properties;
        new maplibregl.Popup({ offset: 10 })
          .setLngLat(f.geometry.coordinates)
          .setHTML(`<div style="font-size:12px;line-height:1.3;">
            <strong>Fecha (local):</strong> ${p.timestamp_local ? new Date(p.timestamp_local).toLocaleString() : '–'}<br/>
            <strong>Sensor:</strong> ${p.source ?? '–'}<br/>
            <strong>Satélite:</strong> ${p.satellite ?? '–'}<br/>
            <strong>Confianza:</strong> ${p.confidence ?? '–'}<br/>
            <strong>FRP:</strong> ${p.frp ?? '–'}
          </div>`)
          .addTo(map);
      });

      ['unclustered-point','clusters'].forEach(l => {
        map.on('mouseenter', l, () => map.getCanvas().style.cursor = 'pointer');
        map.on('mouseleave', l, () => map.getCanvas().style.cursor = '');
      });

      map.on('click', 'clusters', (e) => {
        const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        const clusterId = features[0].properties.cluster_id;
        map.getSource('fires').getClusterExpansionZoom(clusterId, (err, zoom) => {
          if (err) return;
          map.easeTo({ center: features[0].geometry.coordinates, zoom });
        });
      });
    }

    async function refreshData() {
      const window = timeSelector.value;
      const data = await fetchFireData(window);
      updateLayers(data);
    }

    timeSelector.addEventListener('change', refreshData);
    heatmapToggle.addEventListener('change', () => {
      if (map.getLayer('heatmap')) {
        map.setLayoutProperty('heatmap', 'visibility', heatmapToggle.checked ? 'visible' : 'none');
      }
    });
  </script>
</body>
</html>
